#!/sbin/openrc-run
# Copyright 2019 Gentoo Authors
# Distributed under the terms of the GNU General Public License v2

nodename="${RC_SVCNAME#net[.]}"
description="node ${nodename}"

depend() {
	if [[ "${nodename}" != node ]];then
		if [[ "${nodename}" != $(hostname) ]];then
			need "node-storage_${nodename}" "node-net_${nodename}" !node-dhcpd_anynode !node-bootsrv_anynode
		fi
	fi
}

__status() {
    level=$(ssh -o ConnectTimeout=1 "root@${nodename}" "rc-status -r" 2> /dev/null)
	for uplevel in ${uplevels};do
    	if [[ "${level}" = "${uplevel}" ]] && ! service_stopping "${nodename}"; then
			mark_service_started "${nodename}"
			break
		fi
	done
	service_started "${nodename}"
}

status() {
 	if [[ "${nodename}" != $(hostname) ]];then
		__status
	fi
    default_status
}

start() {
 	if [[ "${nodename}" != $(hostname) ]];then
    	ebegin "Starting ${nodename}"
    	mark_service_starting "${nodename}"
        rc-service "node-bootsrv_${nodename}" start || eend "failed to start bootsrv for node ${nodename}" || return
        rc-service "node-dhcpd_${nodename}"   start || eend "failed to start dhcpd for node ${nodename}"   || return


    	if [[ -n "${power_on_cmd}" ]]; then
            $power_on_cmd
        fi

    	if [[ -n "${mac_addr}" ]] ; then
    	wol -i "${network_addr}" "${mac_addr}" 1> /dev/null 2> /dev/null
        fi

    	einfo "waiting ${bootwait_time} sec , ${nodename} need some time to come up"
        sleep ${bootwait_time}
    	einfo "maybe ${nodename} is awake now"

    	check=0
    	while true;do
    	  ping -c1 -q ${nodename}  1> /dev/null 2> /dev/null
    	  r1=$?
    	  if [ $r1 == 0 ];then
		  	if __status 1>/dev/null 2>/dev/null ;then
				if [[ -n $finish_cmd ]];then
					einfo "running final task"
					$finish_cmd && eend 0 || eend 1 || eerror "Final task failed.Cmd was:\"${finish_cmd}\""
					else
						eend 0
				fi
				break
			fi
    	  else
    	      sleep 1
    	      wol -i "${network_addr}" "${mac_addr}" 1> /dev/null 2> /dev/null
    	  fi
    	  sleep 1
    	done
	fi
    rc-service "node-bootsrv_${nodename}" stop   || eerror  "failed to stop bootsrv for node ${nodename}"
    rc-service "node-dhcpd_${nodename}"   stop   || eerror  "failed to stop dhcpd for node ${nodename}"
    eend 0
}

stop() {
 	if [[ "${nodename}" != $(hostname) ]];then
		ebegin "Stopping ${nodename}..."
        if [[ -n "${wol_interface_name}" ]] ; then
		    ssh -o ConnectTimeout=1 root@${nodename} ethtool -s $wol_interface_name wol bg || eend 1 || return
		    einfo "$(ssh -o ConnectTimeout=1 root@${nodename} ethtool $wol_interface_name |grep 'Wake-on:')"
        fi
		ssh -o ConnectTimeout=2 root@${nodename} openrc-shutdown -p now 1> /dev/null 2> /dev/null || eend 1 || return
		r0=$?
		if [ $r0 == 0 ];then
			## shutdown should be in progress...
			sleep 7
		else
			ewarn warning , first connection attempt failed
		fi
		check=0
		while true;do
			ping -c1 -q ${nodename}  1> /dev/null 2> /dev/null
			r1=$?
			
			#sudo ethtool "${network_if}"|grep -q "Speed: 100Mb/s"
			#r2=$?
			#
			#sudo ethtool "${network_if}"|grep -q "Speed: 10Mb/s"
			#r3=$?
			
			#if [ "${r1}" == "1" ] && [ "${r2}" == "0" ];then
			#    if [ "${check}" == "ok" ];then
			#          break
			#    fi
			#    check="ok"
			#elif [ "${r1}" == "1" ] && [ "${r3}" == "0" ];then
			#    if [ "${check}" == "ok" ];then
			#          break
			#    fi
			#    check="ok"
			#fi

			if [ "${r1}" == "1" ] ;then
			    if [ "${check}" == "ok" ];then
			          break
			    fi
			    check="ok"
			fi

			#ssh -o ConnectTimeout=1 root@${nodename} shutdown -h now 2> /dev/null 1> /dev/null
			sleep 3
		done
		$power_off_cmd
		retcode="$?"
		# in case of instant restart
		# need cooldown
		sleep 3
		eend $retcode
	fi
}

