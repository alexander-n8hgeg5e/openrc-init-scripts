#!/sbin/openrc-run

. "$RC_LIBEXECDIR"/sh/rc-cluster-callback.sh

name="${RC_SVCNAME}"
providingnode_servicename="${name#*_}"
providingnode="${providingnode_servicename%%_*}"
servicename="${name##*_}"
#
# symlink format (RC_SVCNAME) := [^_]*_([^_]+)_(.*)
# \1 := nodename
# \2 := servicename
#
description="This is the cluster service \"${servicename}\" provided by node \"${providingnode}\""

depend() {
provide "cluster_${servicename}" "${servicename}"
}

start() {
    ebegin "Starting service \"${servicename}\" on \"${providingnode}\""
    ssh root@"${providingnode}" rc-service "${servicename}" start || eend 1 || return
                                rc-service "${servicename}" start || eend 1 || return
    eend 0
}


stop() {
    ebegin "Stopping service \"${servicename}\" on \"${providingnode}\""
    ssh root@"${providingnode}" rc-service "${servicename}" stop || eend 1 || return
                                rc-service "${servicename}" stop || eend 1 || return
    eend 0
}

status(){
    ssh root@"${providingnode}" rc-service "${servicename}" status
    retcode0=$?
                                rc-service "${servicename}" status
    retcode1=$?
    if [[ $retcode0 -eq $retcode1 ]];then
        return $retcode0
    else # 32:= crashed 16:=inactive 8:=starting 4:=stopping 0:= started 3:= stopped
         # 64:= undefined
        if [[ $retcode0 -eq 32 ]] || [[ $retcode1 -eq 32 ]];then return 32;fi
        if [[ $retcode0 -eq  8 ]] && [[ $retcode1 -eq  4 ]];then return  1;fi
        if [[ $retcode0 -eq  4 ]] && [[ $retcode1 -eq  8 ]];then return  1;fi
        if [[ $retcode0 -eq  8 ]] && [[ $retcode1 -eq 16 ]];then return  8;fi
        if [[ $retcode0 -eq  4 ]] && [[ $retcode1 -eq 16 ]];then return  4;fi
        if [[ $retcode0 -eq 16 ]] && [[ $retcode1 -eq  8 ]];then return  8;fi
        if [[ $retcode0 -eq 16 ]] && [[ $retcode1 -eq  4 ]];then return  4;fi
        return 64
    fi
}

