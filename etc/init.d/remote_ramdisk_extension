#!/sbin/openrc-run
# Copyright 2020 Gentoo Authors
# Distributed under the terms of the GNU General Public License v2

name="remote_ramdisk_extension"
description="adds remote ramdisk to local filesystem"

depend() {
need nbd-ramdisk-0
}

start() {
 ebegin "adding dev \"/dev/nbd0\" to btrfs-fs at \"/run/tmp\""
 if [[ $(df -h /run/tmp | tail -n+2|cut -d' ' -f1) = "/dev/loop0" ]];then
 	if [[ $(losetup -O back-file /dev/loop0 |tail -n+2) = /run/tmp.img ]];then
		btrfs dev add /dev/nbd0 /run/tmp
		eend 0 ;return
	fi
 fi
 eend 1 return
}

stop() {
 ebegin "removing dev \"/dev/nbd0\" from btrfs-fs at \"/run/tmp\""
 if [[ $(df -h /run/tmp | tail -n+2|cut -d' ' -f1) = "/dev/loop0" ]];then
 	if [[ $(losetup -O back-file /dev/loop0 |tail -n+2) = /run/tmp.img ]];then
		btrfs dev del /dev/nbd0 /run/tmp
		eend 0 ;return
	fi
 fi
 eend 1 return
}
